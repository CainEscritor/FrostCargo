<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Productos</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 50px 0;
        padding-bottom: 300px;
      }

      .panel {
        background: white;
        border-radius: 12px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
      }
      .formulario-gestion {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
      }
      input {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .btn-azul {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-borrar {
        background: #f44336;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .footer-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        padding: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
        border-top: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <h1 style="text-align: center">Gestión de Productos e IDs</h1>
    <main id="contenedor-gestion"></main>

    <footer class="footer-nav">
      <a
        href="index.html"
        style="
          background: #34495e;
          color: white;
          padding: 10px;
          text-decoration: none;
          border-radius: 6px;
        "
        >Volver al Inicio</a
      >

      <a
        href="stock.html"
        style="
          background: #c50014;
          color: white;
          padding: 10px;
          text-decoration: none;
          border-radius: 6px;
        "
        >Volver a Stock</a
      >

      <a
        href="agregarStock.html"
        style="
          background: #4caf50;
          color: white;
          padding: 10px;
          text-decoration: none;
          border-radius: 6px;
        "
        >Ir a Cargar Cantidades</a
      >

      <a
        href="modificarProducto.html"
        style="
          background: #ff9800;
          color: white;
          padding: 10px;
          text-decoration: none;
          border-radius: 6px;
        "
        >Modificar Producto</a
      >
    </footer>

    <script type="module">
      import { db } from "./firebase.js";
      import {
        doc,
        setDoc,
        updateDoc,
        deleteField,
      } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const colecciones = [
        "StockCarnicos",
        "StockFrigorBalde",
        "StockFrigorImpulsivos",
        "StockFrigorPostres",
        "StockFrigorPotes",
        "StockGlupsGranel",
        "StockGlupsImpulsivos",
        "StockGudfud",
        "StockInal",
        "StockLambweston",
        "StockMexcal",
        "StockOrale",
        "StockPripan",
        "StockSwift",
      ];
      const nombres = {
        StockCarnicos: "Productos Extras",
        StockFrigorBalde: "Frigor Baldes",
        StockFrigorImpulsivos: "Frigor Impulsivos",
        StockFrigorPostres: "Frigor Postres",
        StockFrigorPotes: "Frigor Potes",
        StockGlupsGranel: "Glups Granel",
        StockGlupsImpulsivos: "Glup Impulsivos",
        StockGudfud: "Gudfud",
        StockInal: "Inal",
        StockLambweston: "Lambweston",
        StockMexcal: "Mexcal",
        StockOrale: "Orale",
        StockPripan: "Pripan",
        StockSwift: "Swift",
      };

      const contenedor = document.getElementById("contenedor-gestion");

      colecciones.forEach((col) => {
        const div = document.createElement("div");
        div.className = "panel";
        div.innerHTML = `
                <h2>${nombres[col]}</h2>
                <div class="formulario-gestion">
                    <label>Nombre del producto</label>
                    <input type="text" id="n-${col}" placeholder="Ej: Hamburguesa">
                    <label>ID del producto</label>
                    <input type="text" id="i-${col}" placeholder="Ej: CAR-001">
                    <button class="btn-azul" id="btn-a-${col}">Agregar Producto</button>
                </div>
                <hr>
                <div class="formulario-gestion">
                    <label>Borrar producto</label>
                    <input type="text" id="b-${col}" placeholder="Nombre exacto">
                    <button class="btn-borrar" id="btn-b-${col}">Borrar Producto</button>
                </div>
            `;
        contenedor.appendChild(div);

        // BOTÓN AGREGAR (Modificado para centralizar IDs)
        document.getElementById(`btn-a-${col}`).onclick = async () => {
          const nom = document.getElementById(`n-${col}`).value.trim();
          const idProd = document.getElementById(`i-${col}`).value.trim();
          if (!nom || !idProd) return alert("Completa ambos campos");

          try {
            // 1. Guarda en la colección de Stock de la categoría correspondiente
            await setDoc(doc(db, col, "Stock"), { [nom]: 0 }, { merge: true });

            // 2. MODIFICACIÓN: Guarda en la colección "idProductos" documento "idProducto"
            await setDoc(
              doc(db, "idProductos", "idProducto"),
              { [nom]: idProd },
              { merge: true },
            );

            alert("Creado correctamente!");
            document.getElementById(`n-${col}`).value = "";
            document.getElementById(`i-${col}`).value = "";
          } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar");
          }
        };

        // BOTÓN BORRAR (Modificado para borrar del documento único)
        document.getElementById(`btn-b-${col}`).onclick = async () => {
          const nom = document.getElementById(`b-${col}`).value.trim();
          if (
            !nom ||
            !confirm("¿Borrar el producto y su ID de todo el sistema?")
          )
            return;

          try {
            // Borra de la colección de Stock de la categoría
            await updateDoc(doc(db, col, "Stock"), { [nom]: deleteField() });

            // Borra del documento central de IDs
            await updateDoc(doc(db, "idProductos", "idProducto"), {
              [nom]: deleteField(),
            });

            alert("Eliminado");
            document.getElementById(`b-${col}`).value = "";
          } catch (error) {
            console.error("Error:", error);
          }
        };
      });
    </script>
  </body>
</html>
